# Using the Logic Analyzer with pico-ice

The **pico-ice** is an FPGA development board featuring the **ICE40UP5K FPGA** paired with the **RP2040** microcontroller. This guide explains how to use Dr. Gusman's Logic Analyzer firmware with the pico-ice board for debugging FPGA projects.

## Overview

The pico-ice Logic Analyzer firmware provides a seamless integration between FPGA development and logic analysis. The RP2040 handles both FPGA configuration management and high-speed logic capture, making it an ideal tool for FPGA debugging and verification.

## Prerequisites

### 1. FPGA Flash Programming Required

**‚ö†Ô∏è IMPORTANT: You must program the FPGA flash memory before using the Logic Analyzer.**

The pico-ice Logic Analyzer firmware does **NOT** program the FPGA flash. You need to:

1. Program your FPGA bitstream to the onboard flash memory using standard pico-ice tools
2. Ensure your FPGA design is stored in flash and ready for configuration
3. Only then use the Logic Analyzer firmware

**Programming Tools:**
- Use the official pico-ice SDK and tools for flash programming
- Refer to the [pico-ice documentation](https://pico-ice.tinyvision.ai/md_getting__started.html) for detailed programming instructions
- Popular tools include `iceprog`, `openFPGALoader`, or the pico-ice MicroPython utilities

### 2. Hardware Requirements

- pico-ice development board
- USB cable for connection to host computer
- paper clip to put the pico-ice in bootsel mode
- FPGA bitstream programmed in flash memory

## How It Works

### FPGA Initialization Sequence

When the Logic Analyzer firmware starts:

1. **Reset Release**: The RP2040 pulls `CRESETN` (GPIO27) high, releasing the FPGA from reset
2. **Clock Start**: The RP2040 immediately starts a **10MHz clock** on `PIN_CLOCK` (GPIO24) using PIO for improved reliability
3. **Configuration Loading**: The ICE40UP5K automatically loads its configuration from onboard flash memory
4. **Configuration Complete**: The FPGA asserts `CDONE` (GPIO26) when configuration is successful (monitored for timeout but not required)
5. **Logic Analysis Ready**: The Logic Analyzer is now ready to capture signals while maintaining FPGA operation

### Improved Reliability

**Note**: The firmware uses an **immediate clock start** approach for improved reliability. Instead of waiting for CDONE assertion (which can have voltage level issues), the FPGA clock starts immediately after reset release. This ensures consistent operation while still monitoring CDONE for timeout detection.

### Dual Functionality

The firmware provides **dual functionality**:
- **FPGA Support**: Manages FPGA configuration, reset control, and clock generation
- **Logic Analysis**: Captures high-speed digital signals from GPIO pins for analysis

## Pin Configuration

### FPGA Control Pins
- **GPIO27** (`CRESETN`) - FPGA reset control (active-low) - **OUTPUT**
- **GPIO26** (`CDONE`) - FPGA configuration done status - **INPUT**
- **GPIO24** (`PIN_CLOCK`) - FPGA clock output (10MHz) - **OUTPUT**

### SPI Flash Programming Pins
- **GPIO8** (`ICE_SI`) - SPI MOSI to FPGA
- **GPIO11** (`ICE_SO`) - SPI MISO from FPGA  
- **GPIO10** (`ICE_SCK`) - SPI clock
- **GPIO9** (`ICE_SSN`) - SPI chip select (active-low)
- **GPIO14** (`RAM_SS`) - External PSRAM chip select

### Logic Analyzer Capture Pins and Channel Mapping

The Logic Analyzer can monitor these GPIO pins:
- **GPIO0-GPIO7** - General purpose I/O
- **GPIO12-GPIO27** - Extended I/O range

**Channel to GPIO Pin Mapping:**
```
Logic Analyzer Channel ‚Üí GPIO Pin
Channel 01 ‚Üí GPIO0
Channel 02 ‚Üí GPIO1
Channel 03 ‚Üí GPIO2
Channel 04 ‚Üí GPIO3
Channel 05 ‚Üí GPIO4
Channel 06 ‚Üí GPIO5
Channel 07 ‚Üí GPIO6
Channel 08 ‚Üí GPIO7
Channel 09 ‚Üí GPIO12
Channel 10 ‚Üí GPIO13
Channel 11 ‚Üí GPIO14
Channel 12 ‚Üí GPIO15
Channel 13 ‚Üí GPIO20
Channel 14 ‚Üí GPIO21
Channel 15 ‚Üí GPIO22
Channel 16 ‚Üí GPIO23
Channel 17 ‚Üí GPIO24 (FPGA Clock) üïê
Channel 18 ‚Üí GPIO25
Channel 19 ‚Üí GPIO26 (CDONE) üì°
Channel 20 ‚Üí GPIO27 (CRESETN) üîÑ

Note: üïê = 10MHz FPGA clock output
üì° = FPGA configuration done status  
üîÑ = FPGA reset control (active-low)
```

**Important Notes:**
- **Channels 17, 19, 20** (GPIO24, 26, 27) have special FPGA functions but can still be monitored
- **GPIO24** shows the 10MHz FPGA clock - useful for timing reference
- **GPIO26** shows FPGA configuration status (high when FPGA is configured)
- **GPIO27** shows FPGA reset control (should stay high during normal operation)

**Note**: GPIO24 and GPIO27 are **output pins** but can still be **monitored** by the Logic Analyzer. The firmware uses universal pin state preservation to maintain their output state while allowing signal capture. **All pin configurations remain unchanged** after capture operations.

### Status LEDs
- **GPIO13** - Red LED (active-low)
- **GPIO12** - Green LED (active-low)  
- **GPIO15** - Blue LED (active-low)

## Clock Configuration

The FPGA receives a **10MHz clock** generated by the RP2040's PIO system.

### Changing the FPGA Clock Frequency

To modify the clock frequency, edit the `fpga_start_clock()` function in `LogicAnalyzer_FPGA.c`:

```c
void fpga_start_clock() {
    // Calculate divider for desired frequency
    // Current: 10MHz = system_clock / divider
    float divider = (float)clock_get_hz(clk_sys) / 10000000.0f; // 10MHz
    
    // For different frequencies:
    // 5MHz:  float divider = (float)clock_get_hz(clk_sys) / 5000000.0f;
    // 25MHz: float divider = (float)clock_get_hz(clk_sys) / 25000000.0f;
    
    pio_sm_set_clkdiv(pio1, fpga_clock_sm, divider);
}
```

## Usage Instructions

### 1. Build and Flash the Firmware

```bash
# Configure for pico-ice
cmake -DBOARD_TYPE=BOARD_PICO_ICE ..
make -j8

# Flash the resulting .uf2 file to your pico-ice
```

### 2. Connect to Logic Analyzer Software

1. Connect the pico-ice to your computer via USB
2. The device will identify as "Logic Analyzer (pico-ice)"
3. Use Dr. Gusman's Logic Analyzer software to connect
4. The software communicates via USB CDC using escaped binary protocol

### 3. Verify FPGA Operation

Before capturing signals:
1. Check that your FPGA configuration loaded successfully
2. Verify the 10MHz clock is present on GPIO24
3. Confirm CRESETN (GPIO27) is at 3.3V
4. Ensure CDONE (GPIO26) is high

### 4. Capture Logic Signals

- Configure capture channels in the Logic Analyzer software
- You can monitor both FPGA I/O and RP2040 GPIO pins
- GPIO24 (FPGA clock) and GPIO27 (CRESETN) can be captured while maintaining their output functions

## Advanced Features

### Multi-Core Architecture

The pico-ice Logic Analyzer uses both RP2040 cores:
- **Core 0**: Main Logic Analyzer functionality, USB communication, FPGA management
- **Core 1**: Available for user applications

**Core 1 is available for custom user code!** You can implement additional functionality on Core 1 while the Logic Analyzer runs on Core 0.

### Universal Pin State Preservation

The firmware implements complete pin state preservation:
- **All pin states are preserved** during and after Logic Analyzer capture operations
- **Output pins** (like FPGA clock) maintain their output state and continue driving
- **Input pins** maintain their input configuration and pull-up/pull-down settings
- **High-Z pins** remain in high-impedance state  
- **Core 1 user applications** are completely unaffected by Logic Analyzer operations
- **FPGA applications** continue running without any pin state disruption
- Logic Analyzer only **reads** pin states - never changes pin configurations

### Real-time FPGA Monitoring

The Logic Analyzer can capture FPGA signals in real-time while the FPGA continues normal operation:
- Monitor FPGA I/O signals
- Debug timing relationships
- Capture FPGA clock for timing reference
- Analyze FPGA-to-RP2040 communication

## Troubleshooting

### FPGA Not Configuring
- Verify FPGA flash is programmed with valid bitstream
- Check that CRESETN (GPIO27) reaches 3.3V
- Ensure CDONE (GPIO26) goes high after configuration

### No FPGA Clock
- Verify CDONE is high before expecting clock
- Check GPIO24 with oscilloscope for 10MHz signal
- Ensure Logic Analyzer capture isn't interfering with clock output

### Logic Analyzer Connection Issues
- Verify USB connection and drivers
- Check that device identifies as "Logic Analyzer (pico-ice)"
- Ensure Logic Analyzer software supports the pico-ice variant

## Technical Specifications

- **MCU**: RP2040 (Dual ARM Cortex-M0+ @ 125MHz)
- **FPGA**: ICE40UP5K (5K LUTs, 128KB BRAM, 8 DSP blocks)
- **Logic Analyzer Channels**: Up to 24 channels (GPIO0-7, 12-27)
- **Max Sample Rate**: 100 Msps
- **Capture Memory**: 32KB buffer
- **FPGA Clock**: 10MHz (user configurable)
- **Communication**: USB CDC (escaped binary protocol)

## References

- [pico-ice Official Documentation](https://pico-ice.tinyvision.ai/md_getting__started.html)
- [ICE40UP5K FPGA Datasheet](https://www.latticesemi.com/en/Products/FPGAandCPLD/iCE40UltraPlus)
- [Dr. Gusman's Logic Analyzer Project](https://github.com/gusmanb/logicanalyzer)
- [RP2040 Datasheet](https://datasheets.raspberrypi.com/rp2040/rp2040-datasheet.pdf)

## Contributing

This pico-ice support is designed to be merged with Dr. Gusman's main Logic Analyzer repository. Contributions, bug reports, and improvements are welcome!

---

**Note**: This firmware provides FPGA development board support while maintaining full compatibility with the original Logic Analyzer functionality. The universal pin state preservation ensures reliable operation with any FPGA design and preserves all user application pin configurations.